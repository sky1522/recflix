# 개발 일지 - 2026-02-04

## 오늘의 작업 요약

오늘은 주로 **LLM 캐치프레이즈 기능 구현**, **Redis 캐싱 프로덕션 버그 수정**, **메인 배너 UI 개선**, **무한스크롤 버그 수정** 작업을 진행했습니다.

---

## 1. LLM 캐치프레이즈 기능 (Claude API)

### 개요
영화 상세 페이지에 Anthropic Claude API를 사용하여 동적으로 캐치프레이즈를 생성하는 기능 구현

### 생성된 파일
| 파일 | 설명 |
|------|------|
| `backend/app/services/llm.py` | Claude API 호출 및 Redis 캐싱 서비스 |
| `backend/app/api/v1/llm.py` | `/api/v1/llm/catchphrase/{movie_id}` 엔드포인트 |
| `backend/app/schemas/llm.py` | CatchphraseResponse 스키마 |

### 수정된 파일
| 파일 | 변경 내용 |
|------|----------|
| `backend/app/api/v1/router.py` | llm 라우터 추가 |
| `frontend/lib/api.ts` | `getCatchphrase()` 함수 추가 |
| `frontend/types/index.ts` | `CatchphraseResponse` 타입 추가 |
| `frontend/app/movies/[id]/page.tsx` | 캐치프레이즈 표시 UI |

### 기술적 상세
- **LLM**: Anthropic Claude (claude-sonnet-4-20250514)
- **캐싱**: Redis (TTL 24시간, 키: `catchphrase:{movie_id}`)
- **Fallback**: API 에러 시 DB의 기존 tagline 반환
- **프롬프트**: 영화 제목, 장르, 줄거리 기반 15자 이내 한국어 캐치프레이즈

### API 응답 예시
```json
{
  "movie_id": 550,
  "catchphrase": "자아를 잃어가는 분열의 끝",
  "cached": true
}
```

---

## 2. Redis 캐싱 프로덕션 버그 수정

### 문제
Railway 배포 환경에서 Redis가 localhost에 연결 시도 → 연결 실패

### 원인
`backend/app/services/llm.py`에서 `REDIS_URL` 환경변수를 사용하지 않고 `REDIS_HOST`, `REDIS_PORT`만 사용

### 해결
```python
# 수정 전
_redis_client = aioredis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    ...
)

# 수정 후
if settings.REDIS_URL:
    _redis_client = aioredis.from_url(
        settings.REDIS_URL,
        decode_responses=True,
        socket_connect_timeout=5,
    )
else:
    # 로컬 개발 fallback
    _redis_client = aioredis.Redis(...)
```

### 검증
```bash
curl https://backend-production-cff2.up.railway.app/api/v1/llm/catchphrase/550
# 첫 요청: {"cached": false}
# 두 번째 요청: {"cached": true}
```

---

## 3. 콘솔 에러 수정

### 수정된 이슈들

| 에러 | 해결 |
|------|------|
| `manifest.json` 404 | `frontend/public/manifest.json` 생성 |
| `apple-mobile-web-app-capable` deprecated | `mobile-web-app-capable`로 변경 |
| `icon-192.png` 404 | manifest.json의 icons 배열을 `[]`로 설정 |

### 생성된 파일
- `frontend/public/manifest.json`

### 수정된 파일
- `frontend/app/layout.tsx` (metadata)

---

## 4. 메인 배너 UI 대폭 개선

### 변경 사항

#### 레이아웃 변경
- 높이: `70vh` → `55vh/60vh/65vh` (반응형)
- 영화 정보: 좌측 하단으로 이동
- MBTI 유도 섹션: 우측 상단으로 이동

#### MBTI 유도 메시지 추가
```typescript
const MBTI_MESSAGES = [
  { title: "오늘 날씨엔 어떤 영화가 좋을까요?", desc: "MBTI와 날씨로 맞춤 추천받기" },
  { title: "당신의 MBTI가 원하는 영화는?", desc: "성격에 딱 맞는 영화 찾기" },
  // ...
];
```

#### 내 리스트 버튼 기능 구현
- 로그인 안 됨 → `/login` 리디렉션
- 로그인 됨 → `toggleFavorite()` 호출
- 시각적 피드백:
  - 추가 안 됨: Plus 아이콘 + "내 리스트"
  - 추가됨: Check 아이콘 + "내 리스트에 추가됨" (보라색 배경)
  - 로딩 중: 스피너 표시

### 수정된 파일
- `frontend/components/movie/FeaturedBanner.tsx`
- `frontend/app/page.tsx`

---

## 5. 영화 목록 다양성 개선

### 변경 사항
- 영화 수: 10개 → **50개** (각 섹션당)
- 셔플 로직 추가: 상위 100개에서 랜덤 50개 선택
- 배너-리스트 동기화: featured = popular[0]

### 수정된 파일
- `backend/app/api/v1/recommendations.py`

### 코드 변경
```python
import random

# 상위 100개에서 50개 랜덤 선택
popular_pool = db.query(Movie).filter(...).limit(100).all()
popular = random.sample(popular_pool, min(50, len(popular_pool)))
random.shuffle(popular)

# 배너 동기화
featured = popular[0] if popular else None
```

---

## 6. 텍스트 정렬 개선

### 섹션 타이틀
- 제목과 설명을 한 줄에 배치 (`flex items-baseline gap-3`)

### 영화 카드
- 제목, 연도, 장르 중앙 정렬

### 수정된 파일
- `frontend/components/movie/MovieRow.tsx`
- `frontend/components/movie/HybridMovieRow.tsx`
- `frontend/components/movie/MovieCard.tsx`
- `frontend/components/movie/HybridMovieCard.tsx`

---

## 7. 무한스크롤 버그 수정

### 문제
`/movies` 페이지에서 무한스크롤 모드 켜도 중간에 로딩이 멈춤

### 원인
1. `loadMoreRef` div가 조건부 렌더링 (모드가 켜져야만 존재)
2. IntersectionObserver가 요소 변경 감지 못함
3. 콜백에서 stale closure 문제

### 해결

#### useInfiniteScroll.ts 전면 개선
```typescript
// 1. Callback ref 패턴 사용
const loadMoreRef = useCallback((node: HTMLDivElement | null) => {
  // observer 재설정 로직
}, [enabled, threshold, rootMargin]);

// 2. 최신 콜백 참조 유지 (stale closure 방지)
const onLoadMoreRef = useRef(onLoadMore);
useEffect(() => {
  onLoadMoreRef.current = onLoadMore;
}, [onLoadMore]);

// 3. enabled 옵션 추가
enabled: useInfiniteMode,
```

#### movies/page.tsx 수정
```typescript
const { loadMoreRef } = useInfiniteScroll({
  onLoadMore: loadMore,
  hasMore,
  isLoading: loadingMore,
  enabled: useInfiniteMode,  // 추가
});

// observer target 항상 렌더링
<div ref={loadMoreRef} className="h-10" />
```

---

## 8. 헤더 메뉴 이름 변경

- "영화" → "영화 검색"

### 수정된 파일
- `frontend/components/layout/Header.tsx`

---

## 커밋 히스토리

| 커밋 | 메시지 |
|------|--------|
| f86e6ab | Fix infinite scroll and rename movie menu |
| f1455e3 | Add functional My List button to featured banner |
| ... | (이전 커밋들) |

---

## 내일 확인할 사항

1. **무한스크롤 테스트**: `/movies` 페이지에서 무한스크롤 버튼 켜고 끝까지 스크롤
2. **내 리스트 버튼 테스트**: 로그인 전/후 동작 확인
3. **캐치프레이즈 표시**: 영화 상세 페이지에서 캐치프레이즈 로딩 확인
4. **Redis 캐싱**: 두 번째 요청에서 `cached: true` 확인

---

## 프로덕션 URL

| 서비스 | URL |
|--------|-----|
| Frontend | https://frontend-eight-gules-78.vercel.app |
| Backend | https://backend-production-cff2.up.railway.app |
| API Docs | https://backend-production-cff2.up.railway.app/docs |
